<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tutorial: Migrating deprecated scripts - HomeyScript</title>

  <meta property="og:image" content="https://etc.athom.com/logo/white/256.png"/>
  <link rel="icon" href="https://etc.athom.com/logo/transparent/128.png"/>
  <link rel="icon" type="image/png" href="https://etc.athom.com/logo/transparent/128.png"/>
  <link rel="preload" as="image" href="images/logo.png">
  <link rel="preload" href="styles/homey.min.css" as="style">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="styles/atom-one-light.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@100;300;400;500;700&display=swap"
    rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="styles/homey.min.css">

  <!-- preload javascript -->
  <link rel="preload" as="script" href="scripts/ready.js">
  <link rel="preload" as="script" href="scripts/navigation.js">
  <link rel="preload" as="script" href="scripts/toc.js">
  <link rel="preload" as="script" href="scripts/table.js">
  <link rel="preload" as="script" href="scripts/hash-link.js">
  <link rel="preload" as="script" href="scripts/docs-nav.js">
  <link rel="preload" as="script" href="scripts/hash-highlight.js">
  <link rel="preload" as="script" href="scripts/darkmode.js">

  <!-- Start DarkMode -->
  <script>
    if (localStorage.getItem('darkmode') === 'true') {
      document.documentElement.classList.add('darkmode');
    }
  </script>
  <!-- End DarkMode -->
</head>

<body>


<div class="container">
  <div class="container__top-nav">
    <button data-darkmode-toggle class="darkmode-toggle">
      <span class="darkmode-toggle__icon --mask"></span>
    </button>
    <div class="docs-nav">
      <button data-docs-nav-toggle class="docs-nav__button" title="All documentation"><span
          class="docs-nav__button-icon --mask"></span></button>
      <nav data-docs-nav-menu class="docs-nav__menu component">
        <div class="docs-nav__banner trim">
          <h2>Homey Developers</h2>
        </div>
        <div class="docs-nav__columns">
          <div class="docs-nav__column trim">
            <h3>Homey Apps SDK</h3>
            <ul class="docs-nav__list">
              <li class="docs-nav__item"><a target="_blank" href="https://apps.developer.homey.app/">Documentation</a>
              </li>
              <li class="docs-nav__item"><a target="_blank"
                                            href="https://apps-sdk-v3.developer.homey.app/">Reference</a></li>
            </ul>
            <h3>Homey Web API</h3>
            <ul class="docs-nav__list">
              <li class="docs-nav__item"><a target="_blank" href="https://api.developer.homey.app/">Documentation</a>
              </li>
              <li class="docs-nav__item"><a target="_blank"
                                            href="https://athombv.github.io/node-homey-api/">Reference</a></li>
            </ul>
            <h3>Tools</h3>
            <ul class="docs-nav__list">
              <li class="docs-nav__item"><a target="_blank" href="https://tools.developer.homey.app/">Developer
                  Tools</a></li>
            </ul>
          </div>
          <div class="docs-nav__column trim">
            <h3>Node.js Modules</h3>
            <ul class="docs-nav__list">
              <li class="docs-nav__item"><a target="_blank" href="https://athombv.github.io/node-homey-zigbeedriver/">Homey
                  ZigbeeDriver</a>
              </li>
              <li class="docs-nav__item"><a target="_blank" href="https://athombv.github.io/node-homey-zwavedriver/">Homey
                  ZWaveDriver</a>
              </li>
              <li class="docs-nav__item"><a target="_blank" href="https://athombv.github.io/node-homey-rfdriver/">Homey
                  RFDriver</a>
              </li>
              <li class="docs-nav__item"><a target="_blank" href="https://athombv.github.io/node-homey-log/">Homey
                  Log</a></li>
              <li class="docs-nav__item"><a target="_blank" href="https://athombv.github.io/node-zigbee-clusters/">Zigbee
                  Clusters</a>
              </li>
              <li class="docs-nav__item"><a target="_blank" href="https://athombv.github.io/node-homey-oauth2app/">Homey
                  OAuth2</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
  </div>
  <nav class="navigation container__navigation component">
    <header class="navigation__header">
                <div class="navigation__logo"><a href="index.html"><img class="display-block" src="images/logo.png" width="40" height="40" alt="Homey"></a></div>
                <h2 class="navigation__title"><a href="index.html">HomeyScript</a></h2>
                <button data-navigation-toggle class="navigation__button" title="menu"></button>
             </header><div class="navigation__content" data-navigation-target><div class="navigation__search search">
            <input title="filter" placeholder="Filter..." data-navigation-search class="search__input" type="search">
            <button data-navigation-search-reset class="search__reset --mask" type="button" title="Reset"></button>
           </div><div data-navigation-scroll class="navigation__scroll scroll trim"><div data-navigation class="navigation__menu trim"><nav class="nav-group"><ul class="nav-group__list"><li data-lvl="0" data-search-key="migrate" class="nav-group__item"><a href="tutorial-migrate.html">Migrating deprecated scripts</a></li></ul></nav><nav class="nav-group"><h3 class="nav-group__title">Namespaces</h3><ul class="nav-group__list"><li data-lvl="0" data-search-key="global" class="nav-group__item"><a href="global.html"> global</a></li></ul></nav></div></div></div>
  </nav>

  <main id="main" class="main container__main">
    <div class="flex flex-direction-column flex-fill max-100">
  <div class="flex">
    <div class="main__center">
      <div class="main__content align-baseline">
        <h1 id="introduction" class="text-preset-heading-1">
          Migrating deprecated scripts
        </h1>
      </div>
      <div class="main__index"></div>
    </div>
  </div>
  <div class="flex">
    <div class="main__center">
      <div class="main__content align-baseline">
        <p>To create a unified API for all our products we decided to introduce <a href="https://www.npmjs.com/package/homey-api">homey-api</a> as the successor to <a href="https://www.npmjs.com/package/athom-api">athom-api</a>. New HomeyScript's will automatically use the new API under the same global variable <a href="./global#.Homey"><code>Homey</code></a>.</p>
<p><strong>Editor Scripts</strong> - <a href="https://my.homey.app/scripts/">https://my.homey.app/scripts/</a></p>
<p>All scripts that use the deprecated API will still work but will have a yellow indicator that tells you that it is using the deprecated API version. If your scripts are not using the global Homey API object there is no need to change the code.</p>
<p>To use the new API you have to create a new script and copy over the previous code and change it according to the steps below.</p>
<p><strong>Advanced FlowCards</strong></p>
<p>All Advanced FlowCards that used the inline code editor have been deprecated. To use the new API the same Advanced FlowCard must be added again and the current code can be copied over and changed according the the steps below. The deprecated cards will still work and keep working so if the global Homey API object is not used there is no need to change the code.</p>
<p>To convert scripts to the new API, you can use the following steps:</p>
<h2>Step 1 - Devices</h2>
<p>For a device the <code>driverUri</code> and <code>zoneName</code> properties have been removed. The <code>driverUri</code> is now part of the <code>driverId</code> and the <code>zoneName</code> has to be fetched based on the <code>zone</code> property of the device.</p>
<pre class="prettyprint source lang-javascript"><code>let deviceZone = await device.getZone();

// Or
deviceZone = await Homey.zones.getZone({ id: device.zone });

// Or
const zones = await Homey.zones.getZones();

deviceZone = zones[device.zone];
const zoneName = deviceZone ? deviceZone.name : 'Missing Zone';
</code></pre>
<h2>Step 2 - FlowCards</h2>
<p>The calls to <code>Homey.flow.getFlowCardTriggers</code>, <code>Homey.flow.getFlowCardConditions</code> and <code>Homey.flow.getFlowCardActions</code> now all return an object with key value pairs instead of an array.</p>
<pre class="prettyprint source lang-javascript"><code>// The following code changes from:
const conditionCards = await Homey.flow.getFlowCardConditions();
for (const card of conditionCards) {
  // ...
}

// To:
const conditionCards = await Homey.flow.getFlowCardConditions();
for (const card of Object.values(conditionCards)) {
  // ...
}
</code></pre>
<p>The cards can be referenced by the <code>card.id</code> property. This is also the key of the card in the collection.</p>
<pre class="prettyprint source lang-javascript"><code>const conditionCards = await Homey.flow.getFlowCardConditions();
for (const card of Object.values(conditionCards)) {
  console.log(conditionCards[card.id] === card);
}
</code></pre>
<p>The property <code>uriObj</code> has been removed. Before this would contain some properties of the owner of the card. For example if the card belonged to a device it would contain the device name and the icon.</p>
<p>Now you must fetch the device to which the card belongs. Since the id of a card will always be of the format <code>homey:&lt;ownerType&gt;:&lt;ownerId&gt;:&lt;cardId&gt;</code>. It's easy to get the device from the <code>Homey.devices.getDevices</code> call and find the <code>ownerId</code> or pass the <code>ownerId</code> to the <code>devices.getDevice</code> call.</p>
<pre class="prettyprint source lang-javascript"><code>const [, ownerType, ownerId, cardId] = card.id.split(':');

if (ownerType === 'device') {
  const devices = await Homey.devices.getDevices();
  console.log(devices[ownerId]);

  // Or
  const device = await Homey.devices.getDevice({ id: ownerId });
}
</code></pre>
<p>Calls to <code>Homey.flow.runFlowCardCondition</code> and <code>Homey.flow.runFlowCardAction</code> no longer require the card <code>uri</code> as a parameter.</p>
<pre class="prettyprint source lang-javascript"><code>// The following code changes from:
await Homey.flow.runFlowCardAction({ uri: card.uri, id: card.id, args: { ... } });

// To:
await Homey.flow.runFlowCardAction({ id: card.id, args: { ... } });
</code></pre>
<h2>Step 3 - Insights</h2>
<p>The <code>uriObj</code> property has been deleted from a Log as returned by <a href="https://athombv.github.io/node-homey-api/HomeyAPIV3Local.ManagerInsights.html#getLogs"><code>Homey.insights.getLogs()</code></a> the owner must be matched the same way as with FlowCards.</p>
<h2>Step 4 - FlowToken</h2>
<p>The <code>uriObj</code> property has been deleted from a FlowToken as returned by <a href="https://athombv.github.io/node-homey-api/HomeyAPIV3Local.ManagerFlowToken.html#getFlowTokens"><code>Homey.flowtoken.getFlowTokens()</code></a> the owner must be matched the same way as with FlowCards.</p>
<h2>Step 5 - Drivers</h2>
<p>The <code>uriObj</code> property has been deleted from a Driver as returned by <a href="https://athombv.github.io/node-homey-api/HomeyAPIV3Local.ManagerDrivers.html#getDrivers"><code>Homey.drivers.getDrivers()</code></a>. The icon can now be found under <code>driver.ownerIconObj</code> and the color under <code>driver.color</code>.</p>
<h2>Step 6 - Apps</h2>
<p>The following endpoints on the <a href="https://athombv.github.io/node-homey-api/HomeyAPIV3Local.ManagerApps.App.html"><code>App</code></a> class have been renamed.</p>
<ul>
<li>
<p><code>app.apiGet(path)</code> -&gt; <code>app.get({ path })</code></p>
</li>
<li>
<p><code>app.apiPost(path, body)</code> -&gt; <code>app.post({ path, body })</code></p>
</li>
<li>
<p><code>app.apiPut(path, body)</code> -&gt; <code>app.put({ path, body })</code></p>
</li>
<li>
<p><code>app.apiDelete(path)</code> -&gt; <code>app.delete({ path })</code></p>
</li>
</ul>
<h2>Step 7 - Managers</h2>
<p><code>Homey.zigBee</code> has been renamed to <code>Homey.zigbee</code>.</p>
      </div>
      <div class="main__index">
        
      </div>
    </div>
  </div>
</div>

  </main>
</div>

<script src="scripts/ready.js"></script>
<script src="scripts/navigation.js"></script>
<script src="scripts/toc.js"></script>
<script src="scripts/table.js"></script>
<script src="scripts/hash-link.js"></script>
<script src="scripts/docs-nav.js"></script>
<script src="scripts/hash-highlight.js"></script>
<script src="scripts/darkmode.js"></script>

<link type="text/css" rel="stylesheet" href="styles/atom-one-light.css">
<script src="scripts/highlight.min.js"></script>
<!--<script src="scripts/linenumber.js"></script>-->


<script async defer src="https://sa.athom.com/latest.js"></script>

</body>
</html>